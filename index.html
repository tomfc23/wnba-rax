  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WNBA Rax Stats</title>
    <style>
      body { background-color: #121212; color: #fff; font-family: Arial, sans-serif; padding: 20px; }
      h1 { text-align: center; }
      .controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
      }
      input, select, button {
        padding: 5px;
        font-size: 1em;
        background-color: #1e1e1e;
        border: 1px solid #555;
        color: #fff;
      }
      .search-suggestions {
        background-color: #1e1e1e;
        border: 1px solid #555;
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.9em;
        position: absolute;
        z-index: 1000;
      }
      .search-suggestions div {
        padding: 5px;
        cursor: pointer;
      }
      .search-suggestions div:hover {
        background-color: #333;
      }
      .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #1e1e1e;
      }
      .comparison-table th, .comparison-table td {
        padding: 10px;
        border: 1px solid #333;
        text-align: center;
      }
      .higher { color: #4CAF50; font-weight: bold; }
      .lower { color: #F44336; font-weight: bold; }
      .relative { position: relative; }
      table { width: 100%; border-collapse: collapse; background-color: #1e1e1e; }
      th, td { padding: 10px; border: 1px solid #333; text-align: left; }
      th { background-color: #333; cursor: pointer; }
      tr.clickable:hover { background-color: #2a2a2a; cursor: pointer; }
      h4 { text-align: center; font-weight: normal; color: #ccc;}
      h5 { text-align: center; font-weight: normal; color: #ccc;}
    </style>
  </head>
  <body>
    <h1>WNBA Rax Stats</h1>
    <h4>Made by @tomfc</h4>
    <h5>To apply rax/game filter in comparison mode, select the filter from the dropdown then hit compare again</h5>

    <div class="controls">
      <input type="text" id="playerSearch" placeholder="Search players..." oninput="renderTable()">
      <select id="gamesFilter">
        <option value="full">Full Season</option>
        <option value="10">Last 10 Games</option>
        <option value="15">Last 15 Games</option>
        <option value="20">Last 20 Games</option>
      </select>
      <button onclick="startComparison()">Compare Players</button>
    </div>

    <div id="comparisonInputs" style="display:none; margin-top:10px; flex-wrap: wrap; gap: 5px;">
      <div class="relative">
        <input type="text" id="comparePlayer1" placeholder="Search Player 1..." oninput="showSuggestions(this, 1)" autocomplete="off">
        <div id="suggestions1" class="search-suggestions" style="display:none;"></div>
      </div>
      <div class="relative">
        <input type="text" id="comparePlayer2" placeholder="Search Player 2..." oninput="showSuggestions(this, 2)" autocomplete="off">
        <div id="suggestions2" class="search-suggestions" style="display:none;"></div>
      </div>
      <button onclick="comparePlayers()">Compare Now</button>
      <button onclick="exitComparison()">Back</button>
    </div>

    <div id="comparisonResult"></div>

    <div id="loading">Loading players...</div>
    <div id="error" style="display:none; color:#f88;"></div>

    <table id="playerTable">
      <thead>
        <tr>
          <th data-key="firstName">First Name</th>
          <th data-key="lastName">Last Name</th>
          <th data-key="gamesPlayed">Games Played</th>
          <th data-key="value">Total Rax</th>
          <th data-key="raxPerGame">Rax/Game</th>
        </tr>
      </thead>
      <tbody id="playerBody"></tbody>
    </table>
<script>
const workerUrl = 'https://wnba-rax.tomfconreal.workers.dev/';
let players = [];
let sortKey = 'value';
let sortDir = 'desc';
let gamesFilter = 'full';
let selectedPlayer1 = null;
let selectedPlayer2 = null;

function formatNumber(num) {
  return num.toLocaleString();
}

function next7AMEST() {
  const now = new Date();
  const estNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const target = new Date(estNow);
  target.setHours(7, 0, 0, 0);
  if (estNow >= target) target.setDate(target.getDate() + 1);
  return target.getTime();
}

async function fetchPlayers() {
  const cache = localStorage.getItem('playersCache');
  const cacheTime = parseInt(localStorage.getItem('cacheTimestamp') || '0');
  const now = Date.now();

  if (cache && now < cacheTime) {
    players = JSON.parse(cache);
    players.forEach(p => calculateStats(p));
    renderTable();
    return;
  }

  const res = await fetch(workerUrl);
  const json = await res.json();
  players = (json.items || []).map(item => ({
    id: item.id,
    firstName: item.firstName,
    lastName: item.lastName,
    value: Number(item.value),
    raxPerGame: null,
    gamesPlayed: 0,
    details: null
  }));

  await fetchAllPlayerDetails();
  localStorage.setItem('playersCache', JSON.stringify(players));
  localStorage.setItem('cacheTimestamp', next7AMEST().toString());
}

async function fetchPlayerDetails(player) {
  const res = await fetch(`${workerUrl}player?id=${player.id}`);
  const details = await res.json();
  player.details = details;
  calculateStats(player);
}

async function fetchAllPlayerDetails() {
  await Promise.all(players.map(p => fetchPlayerDetails(p)));
  renderTable();
}

function calculateStats(player) {
  const entries = [...(player.details || [])];
  if (gamesFilter !== 'full') {
    const limit = parseInt(gamesFilter);
    entries.splice(0, entries.length - limit);
  }
  const gameCount = entries.length;
  const totalRax = entries.reduce((sum, entry) => sum + entry.earnings, 0);
  player.gamesPlayed = gameCount;
  player.raxPerGame = gameCount > 0 ? totalRax / gameCount : 0;
}

function renderTable() {
  const searchQuery = document.getElementById('playerSearch').value.toLowerCase();
  const tbody = document.getElementById('playerBody');
  tbody.innerHTML = '';

  const filterLimit = gamesFilter === 'full' ? 0 : parseInt(gamesFilter);

  players.filter(p => 
    p.gamesPlayed >= filterLimit &&
    (`${p.firstName} ${p.lastName}`).toLowerCase().includes(searchQuery)
  ).sort((a, b) => {
    let av = a[sortKey];
    let bv = b[sortKey];
    if (typeof av === 'string') av = av.toLowerCase();
    if (typeof bv === 'string') bv = bv.toLowerCase();
    if (av < bv) return sortDir === 'asc' ? -1 : 1;
    if (av > bv) return sortDir === 'asc' ? 1 : -1;
    return 0;
  }).forEach(player => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${player.firstName}</td>
      <td>${player.lastName}</td>
      <td>${player.gamesPlayed}</td>
      <td>${formatNumber(player.value)}</td>
      <td>${player.raxPerGame.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('loading').style.display = 'none';
}

function startComparison() {
  document.getElementById('comparisonInputs').style.display = 'flex';
  document.getElementById('playerTable').style.display = 'none';
  document.getElementById('comparisonResult').innerHTML = '';
}

function exitComparison() {
  document.getElementById('comparisonInputs').style.display = 'none';
  document.getElementById('playerTable').style.display = 'table';
  document.getElementById('comparisonResult').innerHTML = '';
}

function showSuggestions(inputElem, slot) {
  const query = inputElem.value.toLowerCase();
  const suggestionsDiv = document.getElementById('suggestions' + slot);
  if (query.length < 1) {
    suggestionsDiv.style.display = 'none';
    return;
  }
  const matched = players.filter(p => (p.firstName + ' ' + p.lastName).toLowerCase().includes(query));
  suggestionsDiv.innerHTML = matched.map(p => `<div onclick="selectPlayer(${p.id}, ${slot})">${p.firstName} ${p.lastName}</div>`).join('');
  suggestionsDiv.style.display = matched.length ? 'block' : 'none';
}

function selectPlayer(id, slot) {
  const player = players.find(p => p.id === id);
  if (slot === 1) {
    selectedPlayer1 = player;
    document.getElementById('comparePlayer1').value = `${player.firstName} ${player.lastName}`;
    document.getElementById('suggestions1').style.display = 'none';
  } else {
    selectedPlayer2 = player;
    document.getElementById('comparePlayer2').value = `${player.firstName} ${player.lastName}`;
    document.getElementById('suggestions2').style.display = 'none';
  }
}

function comparePlayers() {
  if (!selectedPlayer1 || !selectedPlayer2) {
    document.getElementById('comparisonResult').innerHTML = '<p style="color:#f88;">Select both players from the dropdown.</p>';
    return;
  }

  // Recalculate using active filter before comparing
  calculateStats(selectedPlayer1);
  calculateStats(selectedPlayer2);

  function compare(val1, val2) {
    if (val1 > val2) return ['higher', 'lower'];
    if (val1 < val2) return ['lower', 'higher'];
    return ['', ''];
  }

  const [gp1, gp2] = compare(selectedPlayer1.gamesPlayed, selectedPlayer2.gamesPlayed);
  const [tr1, tr2] = compare(selectedPlayer1.value, selectedPlayer2.value);
  const [rx1, rx2] = compare(selectedPlayer1.raxPerGame, selectedPlayer2.raxPerGame);

  const tableHTML = `
    <table class="comparison-table">
      <tr><th>Stat</th><th>${selectedPlayer1.firstName} ${selectedPlayer1.lastName}</th><th>${selectedPlayer2.firstName} ${selectedPlayer2.lastName}</th></tr>
      <tr><td>Games Played</td><td class="${gp1}">${selectedPlayer1.gamesPlayed}</td><td class="${gp2}">${selectedPlayer2.gamesPlayed}</td></tr>
      <tr><td>Total Rax</td><td class="${tr1}">${formatNumber(selectedPlayer1.value)}</td><td class="${tr2}">${formatNumber(selectedPlayer2.value)}</td></tr>
      <tr><td>Rax/Game</td><td class="${rx1}">${selectedPlayer1.raxPerGame.toFixed(2)}</td><td class="${rx2}">${selectedPlayer2.raxPerGame.toFixed(2)}</td></tr>
    </table>
  `;
  document.getElementById('comparisonResult').innerHTML = tableHTML;
}

document.getElementById('gamesFilter').addEventListener('change', (e) => {
  gamesFilter = e.target.value;
  players.forEach(p => calculateStats(p));
  renderTable();
});

fetchPlayers();
</script>
  </body>
  </html>
